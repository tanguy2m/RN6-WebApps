#!/bin/sh
# postinst script for rntoolbox

APPDIR=/apps/toolbox
APPNAME=toolbox
. $APPDIR/scripts/utils.sh

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# Function creating a share if it does not already exist
# Parameters:
#  - share name
#  - access means: cifs, ftp, ... or empty
createShare() {
	sharePath=$(rn_nml -g shares | xmllint --xpath "string(//Share[@share-name='$1']/@id)" -)
	if [ -z "$sharePath" ]; then # If the share does not exist
		rn_nml -a share:/*/$1:$2 # Create it
		sharePath=$(rn_nml -g shares | xmllint --xpath "string(//Share[@share-name='$1']/@id)" -)
	fi
	echo $sharePath
}

_log "Postinst called with the following arguments: $@"

case "$1" in
	configure)
		# 'Admin' share creation if necessary
		adminSharePath=$(createShare admin cifs)

		# Copy default config files
		confPath="/$adminSharePath/config/toolbox"
		mkdir -p $confPath
		for file in $(ls -A $APPDIR/default-config) # List all files except . and ..
		do
			suffix=""
			if [ -f "$confPath/$file" ]; then
				suffix=".original"
			fi
			cp "$APPDIR/default-config/$file" "$confPath/$file$suffix"
		done

		# Restart apache so that all site-enables will be updated
		if systemctl restart apache2.service; then
			# success
			event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="toolbox" success="1"/></add-s>' 0 0
		else
			# error
			event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="toolbox" success="0"/></add-s>' 0 0
		fi
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
	;;

	*)
		_log "postinst called with unknown argument '$1'"
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
