#!/bin/sh
# postinst script for web application

# summary of how this script can be called:
#	* <postinst> `configure' <most-recently-configured-version>
#	* <old-postinst> `abort-upgrade' <new version>
#	* <conflictor's-postinst> `abort-remove' `in-favour' <package>
#		<new-version>
#	* <postinst> `abort-remove'
#	* <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#		<failed-install-package> <version> `removing'
#		<conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

# Parameters definition: APPNAME, mysql, toolbox_version
##PARAMETERS##
. /apps/toolbox/scripts/utils.sh

case "$1" in
	configure)

		########################
		#   Folders creation   #
		########################
		adminSharePath=$(rn_nml -g shares | xmllint --xpath "string(//Share[@share-name='admin']/@id)" -)
		setupPath=/$adminSharePath/setup/$APPNAME
		configPath=/$adminSharePath/config/$APPNAME
		webPath=/apps/$APPNAME/web

		rm -Rf $setupPath # Delete setup directory (package considered latest)
		mkdir -p -m 775 $setupPath $configPath $webPath || error_exit "Cannot create admin share"
		chown admin:admin $configPath $webPath $setupPath || error_exit "Cannot chown admin share"

		####################
		#   Files update   #
		####################
		STATUS=`curl -s -X PUT -w "%{http_code}\\n" "http://localhost/apps/toolbox/api.php/apps/$APPNAME/files/all?v=$toolbox_version" -o /dev/null)`
		if [ $STATUS != 200 ]; then
			error_exit "Cannot update files. HTTP error: $STATUS"
		fi

		##################
		#      MYSQL     #
		##################
		if [ "$mysql" = true ] ; then
			/apps/toolbox/scripts/mysql.sh create $APPNAME $toolbox_version || error_exit "Cannot setup MySQL"
		fi

		# Restart apache so that all site-enables will be updated
		if systemctl restart apache2.service; then
			event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="$APPNAME" success="1"/></add-s>' 0 0
		else
			event_push app readynasd '<add-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="$APPNAME" success="0"/></add-s>' 0 0
		fi
	;;

	abort-remove)
		event_push app readynasd '<delete-s resource-type="LocalApp" resource-id="LocalApp"><LocalApp appname="$APPNAME" success="0"/></delete-s>' 0 0
	;;

	abort-upgrade|abort-deconfigure)
	;;

	*)
		_log "postinst called with unknown argument '$1'"
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
